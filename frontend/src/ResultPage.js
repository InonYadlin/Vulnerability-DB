import React, { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom'; 
import './GlobalStyles.css'; 

function ResultPage() {
    const { name } = useParams();
    // Initialize useNavigate
    const navigate = useNavigate(); 
    const [details, setDetails] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    // Fetch vulnerability details
    useEffect(() => {
        const fetchDetails = async () => {
            try {
                const formattedName = formatNameForQuery(name);
                const response = await fetchDetailsFromAPI(formattedName);
                const data = await response.json();
                
                const uniqueDetails = removeDuplicateDetails(data);
                setDetails(uniqueDetails);
            } catch (error) {
                setError(error.message);
            } finally {
                setLoading(false);
            }
        };

        fetchDetails();
    }, [name]);

    // Utility functions
    const formatNameForQuery = (name) => {
        // Replace dashes with slashes for the query
        return name.replace(/~/g, '/'); 
    };

    const fetchDetailsFromAPI = async (formattedName) => {
        // Assembling the request to the backend
        const url = `http://127.0.0.1:5000/result?q=${encodeURIComponent(formattedName)}`;

        // Getting the results from the api
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response;
    };


    const removeDuplicateDetails = (data) => {
        // Removing duplicate daata if there is any
        return Array.from(new Set(data.map(item => item.name)))
            .map(name => data.find(item => item.name === name));
    };

    const removeLinks = (description) => {
        return description
            // Remove bracketed text
            .replace(/\[(.*?)\]/g, '$1') 
            // Remove links and citations
            .replace(/\([^()]*?(https?:\/\/.*?|Citation:.*?)\)/g, '') 
            // Replace multiple spaces with a single space
            .replace(/\s+/g, ' ') 
            // Trim leading/trailing spaces
            .trim(); 
    };

    const formatForURL = (name) => {
        // Replace slashes with tildas for the URL
        return name.replace(/\//g, '~'); 
    };

    // Render loading, error, or result details
    if (loading) return <div>Loading...</div>;
    if (error) return <div>Error: {error}</div>;

    return (
        <div className="container">
            <main>
                <section className="result-details">
                    {details && details.length > 0 ? (
                        details.map((item, index) => (
                            <div key={index}>
                                <h2>{item.name}</h2>
                                <p>{removeLinks(item.description)}</p>
                                <p><strong>ID:</strong> {item.id}</p>
                                <p><strong>Phase Name:</strong> {item.kill_chain_phases[0].phase_name} </p>
                                <p><strong>Platforms:</strong> {item.x_mitre_platforms.join(', ')}</p>
                                <p><strong>Detection:</strong> {removeLinks(item.x_mitre_detection)}</p>
                                <a href={`https://attack.mitre.org/techniques/${formatForURL(item.external_references[0].external_id)}`}>
                                    Read more on MITRE ATT&CK
                                </a>
                            </div>
                        ))
                    ) : (
                        <p>No details found for this vulnerability.</p>
                    )}
                </section>
                <button onClick={() => navigate('/')}>Go Back to Main Page</button> {}
            </main>
        </div>
    );
}

export default ResultPage;
